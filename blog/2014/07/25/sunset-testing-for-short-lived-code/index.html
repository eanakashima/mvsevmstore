
<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>Sunset Testing for Short-Lived Code - MVSEVMSTORE</title>
  <meta name="author" content="e.a.nakashima">

  
  <meta name="description" content="Rachel Myers and I talked about Sunset Testing in our talks at O’Reilly’s
Fluent Conf 2014 and Front-End Ops Conf, and a number of people asked us if &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mvsevmstore.org/blog/2014/07/25/sunset-testing-for-short-lived-code/">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="MVSEVMSTORE" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,400italic' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53859919-1', 'auto');
    ga('send', 'pageview');
  </script>


</head>

<body >
  <header role="banner"><hgroup>
  <h1><a href="/">MVSEVMSTORE</a></h1>
  <h2>notes on web perf, javascript, css, ruby, design, humans.</h2>
</hgroup>

</header>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Sunset Testing for Short-Lived Code</h1>
    
  </header>





<div class="entry-content"><p><em>Rachel Myers and I talked about Sunset Testing in our talks at O’Reilly’s
Fluent Conf 2014 and Front-End Ops Conf, and a number of people asked us if we
had a blog post on the topic that they could share with their coworkers. We
didn’t, so here it is, somewhat belatedly.</em></p>

<p>When I write some javascript to work around a browser compatibility bug or some
custom ruby to show different configurations for an A/B test, I always have to
get past a bad feeling before checking it in. It helps to write a comment,
something like “Workaround for an IE8 bug,” or “Delete this when we finish the
navigation A/B test,” so it’s obvious when we can remove the code, but it
always feels like a bit of a defeat just to have this code that we know is
short-lived alongside our business logic that’s core to the domain.</p>

<p>Of course, good code organization practices help — browser compatibility code
can be moved into a “polyfills” directory and a good A/B framework can abstract
most of the hurt out of your application — but there’s always a few files
hanging around that you just <em>know</em> you’ll have to go back to in a few months.
For those files, Sunset Tests might be the answer.</p>

<h2>Sunset Tests</h2>

<p>Sunset Tests are tests that remind us to delete or at least revisit temporary
code at some point in the future. I first got the idea from my long-time coworker
<a href="http://github.com/sax">Eric Saxby</a>. We were pairing on a feature A/B test, and as the finishing
touch, he added a test that would fail in a month or so and basically remind us,
“Hey future us, remember that you hate all this A/B test code and want to delete
it now.”  Turns out, there are more places this is useful than just A/B tests.
My coworker/cospeaker <a href="http://github.com/rachelmyers">Rachel Myers</a> coined the term “Sunset Test” and I like it
because it reminds me of all the time I’ll be able to spend on my beach vacation
while everyone without sunset tests is busy wading through old
weird <code>.js.erb</code> files trying to figure out what they do. Err, I mean, I like the
tests because they remind you of when you can sunset your short-lived code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// A/B test testing</span>
</span><span class='line'>
</span><span class='line'><span class="nx">test</span><span class="p">(</span> <span class="err">“</span><span class="nx">homepage</span> <span class="nx">banner</span> <span class="nx">a</span><span class="o">/</span><span class="nx">b</span> <span class="nx">test</span> <span class="nx">is</span> <span class="nx">active</span><span class="err">“</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">today</span>     <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">testEndDate</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="err">“</span><span class="mi">2014</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">19</span><span class="err">”</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">today</span> <span class="o">&lt;</span> <span class="nx">testEndDate</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">ok</span><span class="p">(</span><span class="nx">activeABTests</span><span class="p">.</span><span class="nx">homepage</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">activeABTests</span><span class="p">.</span><span class="nx">homepage</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>My favorite use case for Sunset Tests is as a reminder for when we can pull out
browser compatibility code we don’t need anymore. I’ve worked on a number of
<em>very</em> large Ruby on Rails apps, and run into a lot of random shims &amp; browser
hacks that <em>seem</em> like they might be dead but don’t definitively express their
ability to be deleted. Here’s a good example: this <code>Array.prototype.indexOf</code>
polyfill file. Unless you remember a lot about the dawn of ECMA-262, you might
not know what this is for or whether or not you can take it out. Even if you
<em>do</em> know what it does, do you remember <em>which</em> version of IE added native
support for <code>[‘a’,’b’].indexOf(‘b’)</code>? I don’t. And I added this polyfill to the
codebase.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">indexOf</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">searchElement</span><span class="p">,</span> <span class="nx">fromIndex</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">k</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 1. Let O be the result of calling ToObject passing</span>
</span><span class='line'>    <span class="c1">//    the this value as the argument.</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="k">this</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;&quot;this&quot; is null or not defined&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">//... continues for 150 lines</span>
</span></code></pre></td></tr></table></div></figure>


<p>So we can test it like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">test</span><span class="p">(</span> <span class="err">“</span><span class="nx">indexOf</span> <span class="nx">polyfill</span> <span class="nx">expired</span><span class="o">?</span><span class="err">&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">browserSupport</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">polyfill</span><span class="p">.</span><span class="nx">browserSupport</span><span class="p">;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">today</span>     <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">iE8Sunset</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">browserSupport</span><span class="p">[</span><span class="err">‘</span><span class="nx">ie</span><span class="o">-</span><span class="mi">8</span><span class="err">’</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">today</span> <span class="o">&lt;</span> <span class="nx">iE8Sunset</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">ok</span><span class="p">(</span><span class="nx">polyfilled</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">polyfilled</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is best coupled with a config file that has all the important future dates
you care about. Even if you don’t know the exact date in the future when you’ll
drop support for, say, IE10, it’s worth setting up one of these. Add every
browser version (or every reason for your temporary code), and the date when
you’ll drop support, or the next date you want to think about the problem, if
you don’t know when you’ll drop support. Six months is usually a decently good
runway.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// check our browser analytics on these dates</span>
</span><span class='line'>
</span><span class='line'><span class="nx">browserSupport</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="err">“</span><span class="nx">safari</span><span class="o">-</span><span class="mf">5.0</span><span class="s2">&quot;: &quot;</span><span class="nx">June</span> <span class="mi">01</span> <span class="mi">2014</span><span class="s2">&quot;,</span>
</span><span class='line'><span class="s2">  “ie-8&quot;</span><span class="o">:</span>       <span class="s2">&quot;June 01 2014&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="err">“</span><span class="nx">ie</span><span class="o">-</span><span class="mi">9</span><span class="s2">&quot;:       &quot;</span><span class="nx">January</span> <span class="mi">01</span> <span class="mi">2015</span><span class="err">&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now the cool part: six months from now, you’ll see this test failure, you’ll
have a reminder of what that code is, and you’ll be able to check with your
team and see if you’re ready to remove it.</p>

<p>Voila. One step closer to code that deletes itself.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">e.a.nakashima</span></span>

      








  


<time datetime="2014-07-25T16:40:00-07:00" pubdate data-updated="true">Jul 25<span>th</span>, 2014</time>
    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/02/01/3rd-party-javascript-checklist/" title="Previous Post: 3rd Party Javascript Checklist">&laquo; 3rd Party Javascript Checklist</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/07/25/what-to-say-about-javascript/" title="Next Post: What to Say About JavaScript">What to Say About JavaScript &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About</h1>
  <p>
      MVSEVMSTORE is the personal blog of
      <a href="http://twitter.com/eanakashima">@eanakashima</a>, a developer,
      design nerd, conference speaker and very occasional blog post writer.
  </p>
  <p>
      I bought this domain before CHVRCHES was a thing. It's fine.
  </p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/07/25/what-to-say-about-javascript/">What to Say About JavaScript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/25/sunset-testing-for-short-lived-code/">Sunset Testing for Short-Lived Code</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/01/3rd-party-javascript-checklist/">3rd Party Javascript Checklist</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/03/just-enough-web-perf/">Just Enough Web Perf</a>
      </li>
    
  </ul>
</section>

  
</aside>


      <span class="sidebar-border"></span>
    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - e.a.nakashima -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



</footer>
  












</body>
</html>
